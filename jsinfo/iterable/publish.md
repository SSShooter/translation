
# å¯è¿­ä»£å¯¹è±¡ï¼ˆIterablesï¼‰

*å¯è¿­ä»£å¯¹è±¡*æ˜¯æ•°ç»„çš„æ³›åŒ–ï¼ˆgeneralization of arraysï¼‰ã€‚è¿™ä¸ªæ¦‚å¿µä½¿å¯¹è±¡å¯ä»¥åœ¨ `for..of` å¾ªç¯ä¸­ä½¿ç”¨ã€‚

æ•°ç»„æœ¬èº«å°±æ˜¯å¯è¿­ä»£çš„ã€‚ä½†ä¸æ­¢æ•°ç»„ï¼Œå­—ç¬¦ä¸²ä»¥åŠå¾ˆå¤šå†…å»ºå¯¹è±¡éƒ½æ˜¯å¯è¿­ä»£çš„ã€‚

å¯è¿­ä»£å¯¹è±¡åœ¨ JavaScript å®ç°ä¸­å¹¿æ³›ä½¿ç”¨ï¼Œå¾ˆå¤šæ“ä½œå’Œå†…å»ºæ–¹æ³•éƒ½ä¾èµ–äºå¯è¿­ä»£å¯¹è±¡ã€‚

## Symbol.iterator

ä¸ºäº†ç†è§£å¯è¿­ä»£å¯¹è±¡è¿™ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•è‡ªå·±å†™ä¸€ä¸ªã€‚

ä¾‹å¦‚ï¼Œä¸‹é¢è¿™ä¸ªå¯¹è±¡ï¼Œä¸æ˜¯æ•°ç»„ï¼Œä½†æ˜¯çœ‹èµ·æ¥é€‚ç”¨äº `for..of`ï¼Œ`range` å¯¹è±¡ä»£è¡¨ä¸€ç»„æ•°å­—çš„åŒºé—´ï¼š

```js
let range = {
  from: 1,
  to: 5
};

// We want for..of to work:
// for(let num of range) ... num=1,2,3,4,5
```

è¦è®© `range` å¯è¿­ä»£ï¼ˆè‡ªç„¶å°±èƒ½ç”¨äº `for..of`ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ç»™è¿™ä¸ªå¯¹è±¡åŠ ä¸€ä¸ªåä¸º `Symbol.iterator`ï¼ˆä¸€ä¸ªä¸“ç”¨çš„å†…å»º symbolï¼‰çš„æ–¹æ³•ã€‚

- å½“ `for..of` å¼€å§‹å°±ä¼šè°ƒç”¨æ­¤æ–¹æ³•ï¼ˆæ²¡æœ‰çš„è¯å°±ä¼šæŠ¥é”™ï¼‰ã€‚
- è¿™ä¸ªæ–¹æ³•å¿…å®šè¿”å›ä¸€ä¸ª *è¿­ä»£å™¨ï¼ˆiteratorï¼‰*ï¼ˆä¸€ä¸ªæœ‰ `next` æ–¹æ³•çš„å¯¹è±¡ï¼‰ã€‚
- `for..of` è·å–ä¸‹ä¸€ä¸ªå€¼æ—¶è°ƒç”¨ `next`ã€‚
- `next()` è¿”å›çš„å¿…å®šæ˜¯è¿™ä¸ªæ ¼å¼ `{done: Boolean, value: any}`ï¼Œ`done=true` æ—¶æ„å‘³ç€è¿­ä»£ç»“æŸï¼Œéåˆ™ `value` ä¸ºä¸‹ä¸€ä¸ªå€¼ã€‚

ä»¥ä¸‹æ˜¯ `range` çš„å®Œæ•´å®ç°ï¼š

```js run
let range = {
  from: 1,
  to: 5
};

// 1. call to for..of initially calls this
range[Symbol.iterator] = function() {

  // 2. ...it returns the iterator:
  return {
    current: this.from, // start at "range.from",
    last: this.to,      // end at "range.to"

    // 3. next() is called on each iteration by for..of
    next() {
      if (this.current <= this.last) {
        // 4. it should return the value as an object {done:.., value :...}
        return { done: false, value: this.current++ };
      } else {
        return { done: true };
      }
    }
  };
};

for (let num of range) {
  alert(num); // 1, then 2, 3, 4, 5
}
```

è¿™æ®µä»£ç åŒ…å«äº†åˆ†ç¦»å…³æ³¨ç‚¹çš„æ€æƒ³ï¼š

- `range` æœ¬èº«æ²¡æœ‰ `next()` æ–¹æ³•ã€‚
- è°ƒç”¨ `range[Symbol.iterator]()` ç”Ÿæˆçš„â€œè¿­ä»£å™¨â€ä¸»å¯¼è¿­ä»£è¿‡ç¨‹ã€‚

æ‰€ä»¥è¿­ä»£å™¨å’Œå¯¹è±¡æœ¬èº«æ˜¯åˆ†ç¦»çš„ã€‚

ä»æŠ€æœ¯ä¸Šè®²ï¼Œå¯ä»¥åˆå¹¶ä»–ä»¬ï¼Œä½¿ç”¨ `range` æœ¬èº«ä½œä¸ºè¿­ä»£å™¨ï¼Œä½¿ä»£ç æ›´ç®€æ´ï¼ˆä½†è¿™æœ‰ä¸ªç¼ºç‚¹ï¼‰ï¼š

```js run
let range = {
  from: 1,
  to: 5,

  [Symbol.iterator]() {
    this.current = this.from;
    return this;
  },

  next() {
    if (this.current <= this.to) {
      return { done: false, value: this.current++ };
    } else {
      return { done: true };
    }
  }
};

for (let num of range) {
  alert(num); // 1, then 2, 3, 4, 5
}
```

ç°åœ¨ `range[Symbol.iterator]()` è¿”å› `range` å¯¹è±¡æœ¬èº«ï¼Œä¹Ÿæœ‰è‡ªå·±çš„ `next()` æ–¹æ³•ã€‚æ³¨æ„ï¼Œå½“å‰è¿­ä»£å™¨ä½¿ç”¨çš„æ˜¯ `this.current`ã€‚è¿™æˆ–è®¸å¯ä»¥æ­£å¸¸è¿ä½œï¼Œä½†æ˜¯å½“ä¸¤ä¸ª `for..of` å¾ªç¯åŒæ—¶å¯¹è¿™ä¸ªå¯¹è±¡æ“ä½œï¼šä»–ä»¬å°†ä¼šå…±äº«ä¸€ä¸ªè¿­ä»£å™¨çŠ¶æ€ï¼Œå› ä¸ºè¿™é‡Œé¢åªæœ‰ä¸€ä¸ªè¿­ä»£å™¨â€”â€”å¯¹è±¡æœ¬èº«ã€‚

```smart header="æ— é™è¿­ä»£å™¨"
æ— é™è¿­ä»£å™¨ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚ä¾‹å¦‚æŠŠä¾‹å­æ”¹ä¸º `range.to = Infinity`ï¼Œæˆ–è€…å†™ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡æ— é™ç”Ÿæˆä¼ªéšæœºæ•°ï¼Œè¿™ä¸ªåšæ³•æŒºå®ç”¨ã€‚

`next` æ˜¯æ— é™åˆ¶çš„ï¼Œå®ƒå¯ä»¥è¿”å›æ— æ•°çš„å€¼ã€‚

å½“ç„¶ï¼Œ`for..of` å¾ªç¯ä¼šå› æ­¤å˜æˆæ— é™å¾ªç¯ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ `break` æ¥åœæ­¢å¾ªç¯ã€‚
```


## å­—ç¬¦ä¸²ä¹Ÿå¯è¿­ä»£

æ•°ç»„å’Œå­—ç¬¦ä¸²æ˜¯ä½¿ç”¨å¾—æœ€å¤šå¾—å†…å»ºå¯è¿­ä»£å¯¹è±¡ã€‚

`for..of` å¾ªç¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„å­—ç¬¦ï¼š

```js run
for(let char of "test") {
  alert( char ); // t, then e, then s, then t
}
```

å¯¹ç»„åˆå­—ç¬¦ï¼ˆsurrogate pairsï¼‰ä¹Ÿæ­£å¸¸å·¥ä½œï¼

```js run
let str = 'ğ’³ğŸ˜‚';
for(let char of str) {
    alert(char); // ğ’³, and then ğŸ˜‚
}
```

## æ˜¾å¼è°ƒç”¨è¿­ä»£å™¨

å¯è¿­ä»£å¯¹è±¡é€šå¸¸åªä¸ `for..of` å¾ªç¯åˆä½œï¼Œä½†æ˜¯è¦æ·±å…¥ç†è§£è¿™ä¸ªç©æ„ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦äº†è§£ä¸€ä¸‹å¦‚ä½•æ˜¾å¼åˆ›å»ºä¸€ä¸ªè¿­ä»£å™¨ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨å®ƒï¼Œå®ç° `for..of` ä¸€æ ·çš„æ•ˆæœã€‚

ä¸€ä¸ªä¾‹å­ï¼Œè·å–å­—ç¬¦ä¸²çš„è¿­ä»£å™¨ï¼Œæ‰‹åŠ¨è°ƒç”¨å®ƒï¼š

```js run
let str = "Hello";

// does the same as
// for (let char of str) alert(char);

let iterator = str[Symbol.iterator]();

while(true) {
  let result = iterator.next();
  if (result.done) break;
  alert(result.value); // outputs characters one by one
}
```

è¿™ç§åšæ³•ä¸å¸¸ç”¨ï¼Œä½†ç»™æˆ‘ä»¬æ›´å¤šçš„æ“ä½œè‡ªç”±ã€‚ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥è¿­ä»£éƒ¨åˆ†ï¼Œåœæ­¢ï¼Œå¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œç„¶åç»§ç»­è¿™ä¸ªè¿­ä»£ã€‚

## å¯è¿­ä»£å¯¹è±¡ä¸ç±»æ•°ç»„å¯¹è±¡

è¿™ä¸¤ä¸ªåè¯åˆçœ‹æˆ–è€…æœ‰ç‚¹ç›¸ä¼¼ï¼Œå…¶å®ååˆ†ä¸åŒã€‚

- *å¯è¿­ä»£å¯¹è±¡*æ˜¯å¦‚ä¸Šæ‰€è¿°å®ç°äº† `Symbol.iterator` æ–¹æ³•çš„å¯¹è±¡ã€‚
- *ç±»æ•°ç»„å¯¹è±¡*æ˜¯æ‹¥æœ‰ç´¢å¼•å’Œ `length` çš„å¯¹è±¡ï¼Œçœ‹èµ·æ¥åƒæ•°ç»„ã€‚

å½“ç„¶ï¼Œä¸¤è€…ä¹Ÿå¯ä»¥ç»„åˆèµ·æ¥ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ï¼Œå°±åŒæ—¶ç¬¦åˆä¸¤è€…æ¡ä»¶ã€‚

ä½†æ˜¯å¯è¿­ä»£å¯¹è±¡ä¸ä¸€å®šæ˜¯ç±»æ•°ç»„å¯¹è±¡ï¼Œåä¹‹äº¦ç„¶ã€‚

ä¸Šé¢çš„ `range` æ˜¯å¯è¿­ä»£å¯¹è±¡ï¼Œä½†å®ƒæ²¡æœ‰ç´¢å¼•å’Œ `length`,æ‰€ä»¥å¹¶éç±»æ•°ç»„å¯¹è±¡ã€‚

ä¸‹ä¾‹ä¸­æ˜¯ä¸€ä¸ªç±»æ•°ç»„å¯¹è±¡ï¼Œä½†ä¸æ˜¯å¯è¿­ä»£å¯¹è±¡ï¼š

```js run
let arrayLike = { // has indexes and length => array-like
  0: "Hello",
  1: "World",
  length: 2
};


// Error (no Symbol.iterator)
for(let item of arrayLike) {}

```

å…±åŒç‚¹æ˜¯ï¼Œä»–ä»¬é€šå¸¸**ä¸æ˜¯æ•°ç»„**ï¼Œæ²¡æœ‰ `push`ã€`pop`ç­‰åŠŸèƒ½ã€‚å½“æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªå¯¹è±¡å¯ä»¥åƒæ•°ç»„ä¸€æ ·æ“ä½œçš„æ—¶å€™ï¼Œå°±å¾ˆä¸æ–¹ä¾¿ã€‚

## Array.from

è¿™é‡Œæœ‰ä¸€ä¸ªé€šç”¨æ–¹æ³• [Array.from](mdn:js/Array/from) æŠŠä»–ä»¬ç»„åˆåˆ°ä¸€å—ã€‚å®ƒæ¥å—ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡æˆ–ç±»æ•°ç»„å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªçœŸæ­£çš„æ•°ç»„ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¯¹å…¶è¿›è¡Œæ•°ç»„æ“ä½œã€‚

ä¾‹å­ï¼š

```js run
let arrayLike = {
  0: "Hello",
  1: "World",
  length: 2
};


let arr = Array.from(arrayLike); // (*)

alert(arr.pop()); // World (method works)
```

`(*)` æ ‡æ³¨çš„è¡Œä¸­ `Array.from` æ¥å—ä¸€ä¸ªå¯¹è±¡ï¼Œæ£€æµ‹å®ƒæ˜¯å¦ç¬¦åˆå¯è¿­ä»£å¯¹è±¡æˆ–è€…ç±»æ•°ç»„å¯¹è±¡ï¼Œç„¶åå¤åˆ¶å™¨å†…å®¹è¿”å›ä¸€ä¸ªæ–°æ•°ç»„ã€‚

å¯¹äºå¯è¿­ä»£å¯¹è±¡ï¼š

```js
// assuming that range is taken from the example above
let arr = Array.from(range);
alert(arr); // 1,2,3,4,5 (array toString conversion works)
```

`Array.from` çš„å®Œæ•´è¯­æ³•ä¸­ï¼Œå¯ä»¥æä¾›æ˜ å°„å‡½æ•°ï¼š
```js
Array.from(obj[, mapFn, thisArg])
```

ç¬¬äºŒä¸ªå‚æ•° `mapFn` å‡½æ•°åœ¨å¤„ç†æ¯ä¸€ä¸ªå…ƒç´ åå†æ”¾å…¥æ–°çš„æ•°ç»„ï¼Œ`thisArg` å‚æ•°å¯ä»¥è®¾å®šå®ƒçš„ `this`ã€‚

ä¾‹å­ï¼š

```js
// assuming that range is taken from the example above

// square each number
let arr = Array.from(range, num => num * num);

alert(arr); // 1,4,9,16,25
```

ä¹Ÿå¯ä»¥ç”¨ `Array.from` å¤„ç†å­—ç¬¦ä¸²ï¼š

```js run
let str = 'ğ’³ğŸ˜‚';

// splits str into array of characters
let chars = Array.from(str);

alert(chars[0]); // ğ’³
alert(chars[1]); // ğŸ˜‚
alert(chars.length); // 2
```

ä¸åŒäº `str.split`ï¼Œå®ƒä¾èµ–äºå­—ç¬¦ä¸²çš„å¯è¿­ä»£æ€§ï¼Œå¯ä»¥åƒ `for..of` ä¸€æ ·æ­£ç¡®åˆ†ç¦»ç»„åˆå­—ç¬¦ã€‚

ç”¨ `for..of` å®ç°ç›¸åŒæ•ˆæœï¼š

```js run
let str = 'ğ’³ğŸ˜‚';

let chars = []; // Array.from internally does the same loop
for(let char of str) {
  chars.push(char);
}

alert(chars);
```

...æ˜¾ç„¶ `Array.from` ç®€å•å¤šäº†    

ç”šè‡³å¯ä»¥å®ç°ç»„åˆå­—ç¬¦çš„æˆªå–ï¼š

```js run
function slice(str, start, end) {
  return Array.from(str).slice(start, end).join('');
}

let str = 'ğ’³ğŸ˜‚ğ©·¶';

alert( slice(str, 1, 3) ); // ğŸ˜‚ğ©·¶

// native method does not support surrogate pairs
alert( str.slice(1, 3) ); // garbage (two pieces from different surrogate pairs)
```


## æ€»ç»“

å¯ä»¥ç”¨äº `for..of` çš„å¯¹è±¡ç§°ä¸º*å¯è¿­ä»£å¯¹è±¡*ã€‚

- å¯è¿­ä»£å¯¹è±¡å¿…é¡»å®ç°ä¸€ä¸ª `Symbol.iterator` æ–¹æ³•ã€‚
    - `obj[Symbol.iterator]` è¿”å›ä¸€ä¸ª*è¿­ä»£å™¨*ï¼Œç”¨äºå¤„ç†åç»­è¿­ä»£ã€‚
    - è¿­ä»£å™¨å¿…é¡»æœ‰ `next()` æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ª `{done: Boolean, value: any}`ï¼Œ`done:true` æ—¶ä»£è¡¨è¿­ä»£ç»“æŸï¼Œå¦åˆ™ `value` æˆä¸ºä¸‹ä¸€æ¬¡è¿­ä»£çš„å€¼ã€‚
- `Symbol.iterator` æ–¹æ³•åœ¨ `for..of` ä¸­è‡ªåŠ¨è¢«è°ƒç”¨ï¼Œä½†ä¹Ÿå¯ä»¥æ‰‹åŠ¨è°ƒç”¨ã€‚
- å†…å»ºå¯è¿­ä»£å¯¹è±¡å¦‚å­—ç¬¦ä¸²ã€æ•°ç»„ï¼Œä¹Ÿå®ç°äº† `Symbol.iterator`ã€‚
- å­—ç¬¦ä¸²è¿­ä»£å™¨å¯ä»¥è¯†åˆ«ç»„åˆå­—ç¬¦ï¼ˆsurrogate pairsï¼‰ã€‚


æ‹¥æœ‰ç´¢å¼•å’Œ `length` å±æ€§çš„å¯¹è±¡è¢«ç§°ä¸º*ç±»æ•°ç»„å¯¹è±¡*ã€‚è¿™ç±»å¯¹è±¡å¯ä»¥æ‹¥æœ‰å…¶ä»–å±æ€§å’Œæ–¹æ³•ï¼Œä½†ç¼ºå°‘æ•°ç»„çš„å†…å»ºæ–¹æ³•ã€‚

å¦‚æœæ·±å…¥ç ”ç©¶è§„èŒƒï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å†…å»ºæ–¹æ³•å¤§å¤šå‡è®¾ä»–ä»¬æ˜¯å¯¹å¯è¿­ä»£å¯¹è±¡æˆ–ç±»æ•°ç»„å¯¹è±¡ä½œå¤„ç†ï¼ˆè€Œä¸æ˜¯çœŸæ­£çš„æ•°ç»„ï¼‰ï¼Œå› ä¸ºé‚£æ›´æŠ½è±¡ã€‚

`Array.from(obj[, mapFn, thisArg])` ç”¨å¯è¿­ä»£å¯¹è±¡æˆ–ç±»æ•°ç»„å¯¹è±¡åˆ¶ä½œçœŸæ•°ç»„ï¼Œ`mapFn` å’Œ `thisArg` å‡½æ•°åº”ç”¨äºå…¶ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ã€‚